<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Simulation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    form, .carousel {
      margin: 0 auto;
    }
    label {
      display: block;
      margin-bottom: 8px;
    }
    select, input[type="submit"] {
      margin-bottom: 20px;
    }
    .carousel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .image-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 20px;
      max-width: 100%;
      margin-bottom: 10px;
    }
    .carousel img {
      max-width: 100%;
      max-height: 500px;
      display: block;
    }
    .carousel-buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .carousel-buttons button {
      padding: 5px 10px;
    }
    .agent-name {
      margin-top: 10px;
      font-weight: bold;
    }
    .notice {
      color: red;
      font-weight: bold;
    }
    .description {
      margin-top: 10px;
      font-style: italic;
      color: #555;
    }
    #bias-display {
      margin-top: 20px;
      text-align: center;
    }
    #bias-display img,
    #bias-display video {
      max-width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Agent Simulation</h1>
  <div class="description">
    This tool allows you to simulate different behavioural contagion processes.
    Select your parameters below to see the results.
  </div>

  <form id="simulation-form">
    <label for="agents">Number of Agents:</label>
    <select id="agents" name="agents" required>
      <!-- Options populated from combinations.json -->
    </select>

    <label for="density">Density:</label>
    <select id="density" name="density" required>
      <!-- Options populated based on selected agent count -->
    </select>

    <label for="bias">Bias:</label>
    <select id="bias" name="bias" required>
      <option value="51/49">51/49</option>
      <option value="60/40">60/40</option>
      <option value="70/30">70/30</option>
      <option value="80/20">80/20</option>
      <option value="90/10">90/10</option>
    </select>
    <br>
    <input type="submit" value="Generate">
  </form>

  <div id="notice" class="notice"></div>

  <div class="carousel" id="carousel" style="display: none;">
    <div class="image-container">
      <img id="carousel-image-left" src="" alt="Top View" />
      <img id="carousel-image-right" src="" alt="Main View" />
    </div>
    <div class="carousel-buttons" id="carousel-buttons"></div>
    <div id="agent-name" class="agent-name"></div>
  </div>

  <div id="bias-display" style="display: none;">
    <h2>Bias Display</h2>
    <img id="bias-picture" src="" alt="Bias Picture">
    <video id="bias-video" controls>
      <source src="" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <script>
    let allowedCombinations = {};

    // Load combinations.json and populate the agents dropdown
    fetch('combinations.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load combinations.json');
        }
        return response.json();
      })
      .then(data => {
        allowedCombinations = data;
        populateAgentsDropdown();
      })
      .catch(error => {
        document.getElementById('notice').textContent = `Error: ${error.message}`;
      });

    // Populate the agents dropdown with keys from combinations.json
    function populateAgentsDropdown() {
      const agentsSelect = document.getElementById('agents');
      agentsSelect.innerHTML = '';
      Object.keys(allowedCombinations).forEach(agentCount => {
        let option = document.createElement('option');
        option.value = agentCount;
        option.textContent = agentCount;
        agentsSelect.appendChild(option);
      });
      agentsSelect.value = Object.keys(allowedCombinations)[0];
      updateDensityDropdown();
    }

    // Update the density dropdown based on the selected agent count
    function updateDensityDropdown() {
      const agentsSelect = document.getElementById('agents');
      const densitySelect = document.getElementById('density');
      const selectedAgent = agentsSelect.value;
      densitySelect.innerHTML = '';
      allowedCombinations[selectedAgent].forEach(density => {
        let option = document.createElement('option');
        option.value = density;
        option.textContent = density;
        densitySelect.appendChild(option);
      });
    }

    document.getElementById('agents').addEventListener('change', updateDensityDropdown);

    document.getElementById('simulation-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const agents = document.getElementById('agents').value;
      const density = document.getElementById('density').value;
      const biasValue = document.getElementById('bias').value;

      const notice = document.getElementById('notice');
      const carousel = document.getElementById('carousel');
      const carouselImageLeft = document.getElementById('carousel-image-left');
      const carouselImageRight = document.getElementById('carousel-image-right');
      const agentName = document.getElementById('agent-name');
      const carouselButtons = document.getElementById('carousel-buttons');
      const biasDisplay = document.getElementById('bias-display');

      // Reset previous content
      notice.textContent = '';
      carouselButtons.innerHTML = '';
      carousel.style.display = 'none';
      carouselImageLeft.src = '';
      carouselImageRight.src = '';
      agentName.textContent = '';
      biasDisplay.style.display = 'none';
      document.getElementById('bias-picture').src = '';
      const biasVideoSource = document.getElementById('bias-video').querySelector('source');
      biasVideoSource.src = '';
      document.getElementById('bias-video').load();

      if (!allowedCombinations[agents].includes(density)) {
        notice.textContent = `Invalid density value for ${agents} agents. Allowed values: ${allowedCombinations[agents].join(', ')}.`;
        return;
      }

      // Generate the base folder name (e.g., agents18_dens_2.357)
      const folderName = `agents${agents}_dens_${density}`;

      // Format bias folder name (replace "/" with "_")
      const formattedBias = biasValue.replace('/', '_');
      const biasFolder = `${folderName}/blue_yellow_${formattedBias}`;

      // Load bias picture and video using the /docs/ prefix
      document.getElementById('bias-picture').src = `/docs/${biasFolder}/plot.png`;
      biasVideoSource.src = `/docs/${biasFolder}/animation.mp4`;
      document.getElementById('bias-video').load();
      biasDisplay.style.display = 'block';

      // For agent images, store valid image pairs
      let imagePairs = [];
      let loadedCount = 0;
      let totalImagesToCheck = 50;

      // Attempt to load images for each agent
      for (let i = 1; i <= totalImagesToCheck; i++) {
        loadImagePair(i);
      }

      function loadImagePair(i) {
        const mainImagePath = `/docs/${folderName}/images/agent${i}.png`;
        const topViewImagePath = `/docs/${folderName}/images_top_view/agent${i}.png`;

        let mainImg = new Image();
        let topViewImg = new Image();

        let mainLoaded = false;
        let topLoaded = false;

        mainImg.onload = () => {
          mainLoaded = true;
          checkPair();
        };
        mainImg.onerror = () => {
          checkPair();
        };

        topViewImg.onload = () => {
          topLoaded = true;
          checkPair();
        };
        topViewImg.onerror = () => {
          checkPair();
        };

        mainImg.src = mainImagePath;
        topViewImg.src = topViewImagePath;

        function checkPair() {
          if ((mainLoaded || mainImg.complete) && (topLoaded || topViewImg.complete)) {
            loadedCount++;
            if (mainLoaded && topLoaded) {
              imagePairs.push({
                index: i,
                mainPath: mainImagePath,
                topViewPath: topViewImagePath
              });
            }
            if (loadedCount === totalImagesToCheck) {
              finalizePairs();
            }
          }
        }
      }

      function finalizePairs() {
        imagePairs.sort((a, b) => a.index - b.index);
        if (imagePairs.length === 0) {
          notice.textContent = 'No images found for the selected combination.';
          return;
        }
        displayPair(0);
        buildImageButtons();
      }

      let currentIndex = 0;
      function displayPair(index) {
        carouselImageLeft.src = imagePairs[index].topViewPath;
        carouselImageRight.src = imagePairs[index].mainPath;
        agentName.textContent = 'Agent ' + imagePairs[index].index;
        currentIndex = index;
        carousel.style.display = 'block';
      }

      function buildImageButtons() {
        carouselButtons.innerHTML = '';
        imagePairs.forEach((pair, idx) => {
          let btn = document.createElement('button');
          btn.textContent = 'Agent ' + pair.index;
          btn.addEventListener('click', () => displayPair(idx));
          carouselButtons.appendChild(btn);
        });
      }
    });
  </script>
</body>
</html>
