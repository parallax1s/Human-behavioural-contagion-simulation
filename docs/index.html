<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Simulation</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Behavioral Contagion in Human Groups</h1>
    <!-- Header portrait below the main title -->
    <div class="header-image">
      <img id="head-pic" src="https://raw.githubusercontent.com/FabioReeh/Human-behavioural-contagion-simulation/main/docs/full_scene/head_pic.png" alt="Head Portrait" />
    </div>
  </header>

  <main>
  <section id="intro" class="description">
    <p>We introduce a simulation of a collective decision-making process within a group of human agents performing a two-alternative choice task in a virtual reality (VR) environment.</p>

    <p>In this simulation, agents make decisions based on two sources of information:</p>
    <ol>
      <li>Individual information they receive from their environment</li>
      <li>Social information they receive from observing the decisions of other agents</li>
    </ol>

    <p>The simulations are based on a modified Drift Diffusion Model, adapted to incorporate both individual and social components of decision-making.</p>

    <p>The parameters listed below represent the key independent variables and assumptions that influence (or fail to influence) the dynamics of behavioral contagion within the group.</p>

  </section>

  <section id="controls">
  <form id="simulation-form">
    <label for="agents">Number of Agents:
      <select id="agents" name="agents" required>
        <!-- populated from combinations.json -->
      </select>
    </label>

    <label for="density">Density:
      <select id="density" name="density" required>
        <!-- populated based on agents -->
      </select>
    </label>

    <label for="bias">Environmental cue:
      <select id="bias" name="bias" required>
        <option value="55/45">55/45</option>
        <option value="75/25">75/25</option>
        <option value="95/05">95/05</option>
      </select>
    </label>

    <label for="network-type">Network type:
      <select id="network-type" name="network-type" required>
        <option value="visual">visual</option>
        <option value="metric">metric</option>
      </select>
    </label>

    <label for="env-agents">Environment informed Agents:
      <select id="env-agents" name="env-agents" required>
        <option value="AllGetEnvSignal">All</option>
        <option value="firstRowFollowers">Front row</option>
      </select>
    </label>

    <input type="submit" value="Generate" />
  </form>

  <div class="options-row">
    <label><input type="checkbox" id="toggle-images" checked /> Show scenery</label>
    <label><input type="checkbox" id="toggle-bias" checked /> Show Analysis</label>
    <label><input type="checkbox" id="toggle-vr" checked /> Show VR Setup</label>
    <label><input type="checkbox" id="toggle-advanced" checked /> Show Advanced Analysis</label>
  </div>

  </section>

  <div id="notice" class="notice"></div>

  <section id="vr-setup">
    <h2>VR setup</h2>
    <video id="vr-video" autoplay loop muted>
      <source id="vr-source" src="" type="video/mp4" />
      Your browser does not support the video tag.
    </video>
  </section>

  <section class="carousel" id="carousel" style="display: none;">
    <div id="agent-heading">Agent Images</div>
    <div id="agent-description" class="description">
      From left to the right: Top view of unity scene / Visualization of whos FOV is shown / FOV of selected agent / enviromental cue.
    </div>

    <div class="carousel-flex">
      <img id="unity-image" src="" alt="Unity Top View" />
      <div class="image-container">
        <img id="carousel-image-left" src="" alt="Agent Top View" class="media-item" />
        <img id="carousel-image-right" src="" alt="Agent Main View" class="media-item" />
      </div>
      <img id="env-cue-image" src="" alt="Environmental Cue" />
    </div>

    <div id="agent-controls">
      <button id="prev-agent">&laquo; Previous</button>
      <input type="number" id="agent-index-input" min="1" value="1" />
      <button id="next-agent">Next &raquo;</button>
    </div>
    <div id="agent-name" class="agent-name"></div>
  </section>

  <section id="bias-display">
    <h2>Bias Display</h2>
    <div class="description">Contagion dynamics and decision trajectories.</div>
    <div class="bias-container">
      <img id="bias-picture" src="" alt="Analysis Plot" class="media-item" />
      <video id="bias-video" autoplay loop muted class="media-item">
        <source id="bias-source" src="" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
  </section>

  <section id="advanced-analysis">
    <h2>Advanced Analysis</h2>
    <div class="description">Additional analysis plots based on your selections.</div>
    <div class="analysis-container">
      <img id="state-traj-img" src="" alt="State Trajectory" class="media-item" />
      <img id="wdegree-img" src="" alt="Weighted Degree Distribution" class="media-item" />
    </div>
  </section>

  </main>

  <script>
    let allowedCombinations = {};
    let imagePairs = [];
    let currentIndex = 0;
    const baseUrl = 'https://raw.githubusercontent.com/FabioReeh/Human-behavioural-contagion-simulation/main/docs/';

    // Load combinations.json
    fetch('combinations.json')
      .then(response => {
        if (!response.ok) throw new Error('Failed to load combinations.json');
        return response.json();
      })
      .then(data => {
        allowedCombinations = data;
        populateAgentsDropdown();
      })
      .catch(error => {
        document.getElementById('notice').textContent = `Error: ${error.message}`;
      });

    function populateAgentsDropdown() {
      const agentsSelect = document.getElementById('agents');
      agentsSelect.innerHTML = '';
      Object.keys(allowedCombinations).forEach(agentCount => {
        agentsSelect.append(new Option(agentCount, agentCount));
      });
      agentsSelect.value = Object.keys(allowedCombinations)[0];
      updateDensityDropdown();
    }

    function updateDensityDropdown() {
      const densitySelect = document.getElementById('density');
      const selectedAgent = document.getElementById('agents').value;
      densitySelect.innerHTML = '';
      allowedCombinations[selectedAgent].forEach(density => {
        densitySelect.append(new Option(density, density));
      });
    }

    document.getElementById('agents')
      .addEventListener('change', updateDensityDropdown);

    document.getElementById('simulation-form').addEventListener('submit', function(e) {
      e.preventDefault();

      // Toggles and selections
      const showImages     = document.getElementById('toggle-images').checked;
      const showBiasOption = document.getElementById('toggle-bias').checked;
      const showVR         = document.getElementById('toggle-vr').checked;
      const showAdvanced   = document.getElementById('toggle-advanced').checked;
      const agents         = document.getElementById('agents').value;
      const density        = document.getElementById('density').value;
      const biasValue      = document.getElementById('bias').value;
      const networkType    = document.getElementById('network-type').value;
      const envAgents      = document.getElementById('env-agents').value;

      // UI elements
      const notice         = document.getElementById('notice');
      const carousel       = document.getElementById('carousel');
      const biasDisplay    = document.getElementById('bias-display');
      const vrSetup        = document.getElementById('vr-setup');
      const advancedDisplay= document.getElementById('advanced-analysis');
      const stateImg       = document.getElementById('state-traj-img');
      const wdegreeImg     = document.getElementById('wdegree-img');
      const carouselImageLeft  = document.getElementById('carousel-image-left');
      const carouselImageRight = document.getElementById('carousel-image-right');
      const biasPicture    = document.getElementById('bias-picture');
      const biasSource     = document.getElementById('bias-source');
      const vrSource       = document.getElementById('vr-source');
      const unityImgEl     = document.getElementById('unity-image');
      const envCueImg      = document.getElementById('env-cue-image');
      const agentName      = document.getElementById('agent-name');
      const agentIndexInput= document.getElementById('agent-index-input');

      // Reset previous displays
      notice.textContent = '';
      carousel.style.display = 'none';
      biasDisplay.style.display = 'none';
      vrSetup.style.display = 'none';
      advancedDisplay.style.display = 'none';
      [carouselImageLeft, carouselImageRight, biasPicture, unityImgEl, envCueImg, stateImg, wdegreeImg].forEach(el => el.src = '');
      document.getElementById('bias-video').load();
      document.getElementById('vr-video').load();
      imagePairs = [];
      currentIndex = 0;

      // Validate density
      if (!allowedCombinations[agents].includes(density)) {
        notice.textContent = `Invalid density value for ${agents} agents. Allowed: ${allowedCombinations[agents].join(', ')}.`;
        return;
      }

      // Build folder and file paths
      const folderName    = `agents${agents}_dens_${density}`;
      const formattedBias = biasValue.replace('/', '_');
      const networkFolder = (networkType === 'metric')
        ? 'multiPOV_cond1_metric'
        : 'multiPOV_cond1_visual';
      const envFolder     = envAgents;

      // VR setup
      if (showVR) {
        vrSource.src = baseUrl + 'full_scene/full_scene.mp4';
        document.getElementById('vr-video').load();
        vrSetup.style.display = 'block';
      }

      // Bias analysis
      if (showBiasOption) {
        const analysisBase = `${folderName}/blue_yellow_${formattedBias}`;
        biasPicture.src = `${baseUrl}${analysisBase}/${networkFolder}/${envFolder}/network_perf_distribution/plot.png`;
        biasSource.src  = `${baseUrl}${analysisBase}/${networkFolder}/${envFolder}/contagion_animations/animation.mp4`;
        document.getElementById('bias-video').load();
        biasDisplay.style.display = 'block';
      }

      // Advanced analysis
      if (showAdvanced) {
        const advBase = `advanced_analysis/blue_yellow_${formattedBias}/${networkFolder}/${envFolder}`;
        // load the new file names unconditionally
        stateImg.src    = `${baseUrl}${advBase}/finalState_distribution.png`;
        wdegreeImg.src  = `${baseUrl}${advBase}/RT_NoOutlier_distribution.png`;
        // make sure both images are visible
        wdegreeImg.style.display = '';
        advancedDisplay.style.display = 'block';
      }


      // Scenery images
      if (showImages) {
        unityImgEl.src  = `${baseUrl}${folderName}/images_top_view_unity/top_view.png`;
        envCueImg.src   = `${baseUrl}blue_yellow/${formattedBias}.png`;
      }

      // Agent images
      if (showImages) {
        const totalAgents = parseInt(agents, 10);
        for (let i = 1; i <= totalAgents; i++) {
          loadImagePair(i);
        }
      }

      function loadImagePair(i) {
        const mainPath    = `${baseUrl}${folderName}/images/agent${i}.png`;
        const topPath     = `${baseUrl}${folderName}/images_top_view/agent${i}.png`;
        let mainLoaded    = false;
        let topLoaded     = false;
        const mainImg     = new Image();
        const topImg      = new Image();

        mainImg.onload  = () => { mainLoaded = true; checkPair(); };
        mainImg.onerror = () => { checkPair(); };
        topImg.onload   = () => { topLoaded = true; checkPair(); };
        topImg.onerror  = () => { checkPair(); };

        mainImg.src = mainPath;
        topImg.src  = topPath;

        function checkPair() {
          if ((mainLoaded || mainImg.complete) && (topLoaded || topImg.complete)) {
            if (mainLoaded && topLoaded) {
              imagePairs.push({ index: i, mainPath, topPath });
            }
            if (imagePairs.length === parseInt(agents, 10)) {
              finalizePairs();
            }
          }
        }
      }

      function finalizePairs() {
        imagePairs.sort((a, b) => a.index - b.index);
        if (imagePairs.length === 0) {
          notice.textContent = 'No images found for the selected combination.';
          return;
        }
        agentIndexInput.min = 1;
        agentIndexInput.max = imagePairs.length;
        agentIndexInput.value = 1;
        displayPair(0);
        setupAgentControls();
      }
    });

    function displayPair(idx) {
      const left  = document.getElementById('carousel-image-left');
      const right = document.getElementById('carousel-image-right');
      left.src  = imagePairs[idx].topPath;
      right.src = imagePairs[idx].mainPath;
      document.getElementById('agent-name').textContent = 'Agent ' + imagePairs[idx].index;
      currentIndex = idx;
      document.getElementById('carousel').style.display = 'block';
      document.getElementById('agent-index-input').value = imagePairs[idx].index;
    }

    function setupAgentControls() {
      const prevBtn = document.getElementById('prev-agent');
      const nextBtn = document.getElementById('next-agent');
      const idxInput = document.getElementById('agent-index-input');

      prevBtn.onclick = () => {
        if (currentIndex > 0) displayPair(currentIndex - 1);
      };
      nextBtn.onclick = () => {
        if (currentIndex < imagePairs.length - 1) displayPair(currentIndex + 1);
      };
      idxInput.onchange = () => {
        let val = parseInt(idxInput.value, 10);
        val = Math.max(parseInt(idxInput.min, 10), Math.min(val, parseInt(idxInput.max, 10)));
        displayPair(val - 1);
      };
    }
  </script>
</body>
</html>
